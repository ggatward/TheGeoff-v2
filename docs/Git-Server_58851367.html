<!DOCTYPE html>
<html>
    <head>
        <title>Jenkins SOE : Git Server</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jenkins SOE</a></span>
                            </li>
                                                    <li>
                                <span><a href="Jenkins-Home_56197143.html">Jenkins Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Setup_58261522.html">Setup</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jenkins SOE : Git Server
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Geoff Gatward</span>, last modified on Jul 14, 2017
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>All code for this project is stored in a Git repository. Any Git server can be used - this project was developed using GitHub, but has been deployed in customer environments using both Atlassian Bitbucket and GitLab as the server.  Specific setup for each is included below, as the project makes use of multiple branches of the repository, and uses webhooks from the Git server to trigger production builds when content is promoted.</p><p>In all cases, the master repository (development branch) needs to be cloned and then imported to the customer Git server.  The master repository is located on GitHub at  <a href="https://github.com/ggatward/TheGeoff-v2" class="external-link" rel="nofollow">https://github.com/ggatward/TheGeoff-v2</a></p><p>Also, regardless of the server used, the project (by default) is expecting to find two branches, named master and development.  Once the repository has been uploaded to the Git server, be sure to create a new branch called development. This branch should be set as the default branch<span style="color: rgb(204,153,255);">, and the master branch set to be protected. This ensures that users cloning the project work on the development branch by default, and cannot accidentally commit untested changes to the master branch. </span></p><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1502524877621 {padding: 0px;}
div.rbtoc1502524877621 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1502524877621 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1502524877621'>
<ul class='toc-indentation'>
<li><a href='#GitServer-Initialrepositorycreation'>Initial repository creation</a></li>
<li><a href='#GitServer-GitHub'>GitHub</a>
<ul class='toc-indentation'>
<li><a href='#GitServer-Setthedefaultbranch'>Set the default branch</a></li>
<li><a href='#GitServer-Protectthemasterbranch'>Protect the master branch</a></li>
<li><a href='#GitServer-Configurewebhooks'>Configure webhooks</a></li>
<li><a href='#GitServer-AllowJenkinsaccess'>Allow Jenkins access</a></li>
</ul>
</li>
<li><a href='#GitServer-GitLab'>GitLab</a>
<ul class='toc-indentation'>
<li><a href='#GitServer-Setthedefaultbranch.1'>Set the default branch</a></li>
<li><a href='#GitServer-Protectthemasterbranch.1'>Protect the master branch</a></li>
<li><a href='#GitServer-Configurewebhooks.1'>Configure webhooks</a></li>
<li><a href='#GitServer-AllowJenkinsaccess.1'>Allow Jenkins access</a></li>
</ul>
</li>
<li><a href='#GitServer-Bitbucket'>Bitbucket</a>
<ul class='toc-indentation'>
<li><a href='#GitServer-Setthedefaultbranch.2'>Set the default branch</a></li>
<li><a href='#GitServer-Protectthemasterbranch.2'>Protect the master branch</a></li>
<li><a href='#GitServer-Configurewebhooks.2'>Configure webhooks</a></li>
<li><a href='#GitServer-AllowJenkinsaccess.2'>Allow Jenkins access</a></li>
</ul>
</li>
</ul>
</div></p><h2 id="GitServer-Initialrepositorycreation">Initial repository creation</h2><p>Create a new repository via the relevant web interface (We'll call it 'RHEL-Builder').</p><p>Clone the new repository to your development server</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">geoff@jenkins1[~/Projects/github] $ git clone git@github.com:ggatward/RHEL-Builder.git
Cloning into &#39;RHEL-Builder&#39;...
warning: You appear to have cloned an empty repository.</pre>
</div></div><p>Copy the master project files into the new repository working directory</p><p>Add all files to be tracked, commit and push them to the server (You can customise the Jenkinsfile and Puppetfile here if you know what you need at this stage)</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">geoff@jenkins1[~/Projects/github/RHEL-Builder] *$ git add -A

geoff@jenkins1[~/Projects/github/RHEL-Builder] *$ git commit -a -m &quot;Initial Upload&quot;
[master (root-commit) 88d0d64] Initial Upload
 45 files changed, 4192 insertions(+)
 create mode 100644 Jenkinsfile
 create mode 100644 Puppetfile
&lt;...snip...&gt;
 create mode 100755 setup/r10k/post_deploy.sh
 create mode 100644 setup/r10k/r10k_SOE.yaml

geoff@jenkins1[~/Projects/github/RHEL-Builder] (master)$ git push
Counting objects: 51, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (48/48), done.
Writing objects: 100% (51/51), 53.65 KiB | 0 bytes/s, done.
Total 51 (delta 2), reused 0 (delta 0)
remote: Resolving deltas: 100% (2/2), done.
To git@github.com:ggatward/RHEL-Builder.git
 * [new branch]      master -&gt; master</pre>
</div></div><p>Create a new branch called 'development' and push it back to the Git server</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">geoff@jenkins1[~/Projects/github/RHEL-Builder] (master)$ git checkout -b development
Switched to a new branch &#39;development&#39;


geoff@jenkins1[~/Projects/github/RHEL-Builder] (development)$ git push --set-upstream origin development
Total 0 (delta 0), reused 0 (delta 0)
To git@github.com:ggatward/RHEL-Builder.git
 * [new branch]      development -&gt; development
Branch development set up to track remote branch development from origin.</pre>
</div></div><p>The next steps will vary depending on the Git server being used.</p><h2 id="GitServer-GitHub">GitHub</h2><h3 id="GitServer-Setthedefaultbranch">Set the default branch</h3><p>Open the 'settings' for the new repository and click on the Branches link.  Set the default branch to 'development' and update the settings as shown below.</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="549" width="1021" src="attachments/58851367/58818641.png?width=1021" data-image-src="attachments/58851367/58818641.png" data-unresolved-comment-count="0" data-linked-resource-id="58818641" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="soe1.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="9fc2d85a-854c-43d2-b3e6-46685b31393c" data-media-type="file"></span></p><h3 id="GitServer-Protectthemasterbranch">Protect the master branch</h3><p>TBA (Not yet implemented &amp; tested)</p><h3 id="GitServer-Configurewebhooks">Configure webhooks</h3><p>The webhook is an event that is sent from GitHub to the Jenkins server when specified events are detected. For this project, we will be using a webhook when a push is performed to the repository to trigger Jenkins to perform a new build. The Jenkins side of the configuration will be configured to only process push hooks for specific branches - the GitHub side only configures the hooks as on or off.</p><p>Click on the Webhooks link in the repository Settings, Add webhook, then enter the required details:</p><ul><li>Payload URL - This is the publicly accessible URL of the Jenkins server, with   /github-webhook/  as the target.</li><li>Content type - Jenkins requires this to be the default  application/x-www-form-urlencoded</li><li>Secret - No secret is required.</li></ul><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="794" width="997" src="attachments/58851367/58851407.png?width=997" data-image-src="attachments/58851367/58851407.png" data-unresolved-comment-count="0" data-linked-resource-id="58851407" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="soe2.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="22cc0ea7-5eb0-462a-90d3-b8a892196dbb" data-media-type="file"></span></p><p>Click the Add webhook button to complete the configuration.</p><h3 id="GitServer-AllowJenkinsaccess">Allow Jenkins access</h3><p>The 'jenkins' user on the Jenkins server needs to be granted read/write access to the repository in order to use it. In GitHub this is performed at a global level, from the Profile Settings page.</p><ul><li>Click on the Profile Settings link and then select the 'SSH and GPG keys' option.</li><li>Add a new SSH key, and upload the public ssh key for the jenkins user on the Jenkins server.</li></ul><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-content-image-border" src="attachments/58851367/58294364.png" data-image-src="attachments/58851367/58294364.png" data-unresolved-comment-count="0" data-linked-resource-id="58294364" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="soe3.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="c9e0f1b7-c897-4b3d-9c17-93e13bb7face" data-media-type="file"></span></p><p><br/></p><h2 id="GitServer-GitLab">GitLab</h2><h3 id="GitServer-Setthedefaultbranch.1">Set the default branch</h3><p>Open the 'settings' for the new repository and set the Default Branch to 'development' and update the settings as shown below.</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="422" width="782" src="attachments/58851367/61931524.jpg?width=782" data-image-src="attachments/58851367/61931524.jpg" data-unresolved-comment-count="0" data-linked-resource-id="61931524" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="gl1.jpg" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="203f691f-c873-4a67-ab5d-7a4aa19461dd" data-media-type="file"></span></span></p><h3 id="GitServer-Protectthemasterbranch.1">Protect the master branch</h3><p>Protecting the master branch prevents accidental and/or unauthorised changes being performed directly to that branch. The intent is that only the Jenkins user can merge and push to the master branch, which only occurs after successful validation of the development branch AND passing of the manual approval gate.</p><p>To do this using GitLab the following setup is required.</p><p>All users in GitLab must be defined with a role of 'Developer'.  The Jenkins user is created with a role of 'Master' (This is done in a later step in this guide).</p><p>To set the protection on the repository, navigate to the repository Settings → Repository and then expand the 'Protected Branches' section.</p><p>By default the 'master' branch should be restricted for merge and push actions to users with the 'Masters' role - if this is not the case, correct it to appear as below.</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="702" width="874" src="attachments/58851367/63307814.png?width=874" data-image-src="attachments/58851367/63307814.png" data-unresolved-comment-count="0" data-linked-resource-id="63307814" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="gl04.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="93988cf3-a480-4b51-bcec-7787c6a6c93d" data-media-type="file"></span></p><h3 id="GitServer-Configurewebhooks.1">Configure webhooks</h3><p>The webhook is an event that is sent from GitLab to the Jenkins server when specified events are detected. For this project, we will be using a webhook when a push is performed to the repository to trigger Jenkins to perform a new build. The Jenkins side of the configuration will be configured to only process push hooks for specific branches - the GitLab side only configures the hooks as on or off.</p><p>Click on the Integrations link in the repository Settings, then enter the required details:</p><ul><li>URL - This is the publicly accessible URL of the Jenkins server, with  <span style="color: rgb(0,0,0);"> /project/&lt;JOB_NAME&gt;</span>  as the target.</li><li><span style="color: rgb(0,0,0);">Secret Token - No secret is required.</span></li></ul><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="797" width="779" src="attachments/58851367/61833223.png?width=779" data-image-src="attachments/58851367/61833223.png" data-unresolved-comment-count="0" data-linked-resource-id="61833223" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="gl2.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="75583ce1-82fd-4aac-9768-bc5ecdb02ed0" data-media-type="file"></span></p><p>Next, we need to create an authentication token for the Jenkins user.</p><ul><li>Login to GitLab as the Jenkins user and navigate to the user settingse page.</li><li>Click on the 'Access Tokens' tab, and create a personal access token:</li></ul><p style="padding-left: 30.0px;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-content-image-border" src="attachments/58851367/64454693.png" data-image-src="attachments/58851367/64454693.png" data-unresolved-comment-count="0" data-linked-resource-id="64454693" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="wh1.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="5e8a5a00-a4d0-40a8-84e7-e4a361feda8f" data-media-type="file"></span></p><ul><li>Make note of the token string</li></ul><p style="padding-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="98" width="472" src="attachments/58851367/64847913.png?width=472" data-image-src="attachments/58851367/64847913.png" data-unresolved-comment-count="0" data-linked-resource-id="64847913" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="wh2.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="c1797b2f-c373-4300-84af-7b0c9ada07ce" data-media-type="file"></span></p><ul><li>d</li><li>d</li><li>d</li></ul><p style="padding-left: 30.0px;"><br/></p><h3 id="GitServer-AllowJenkinsaccess.1">Allow Jenkins access</h3><p>The 'jenkins' user on the Jenkins server needs to be granted read/write access to the repository in order to use it.</p><p>First we need to add the Jenkins user to GitLab.</p><ul><li>As a GitLab administrator, navigate to the Admin Area, then click 'New User'.</li><li>Create a new 'Regular' user.  In our example here the username is 'jenkins'.</li></ul><p>Next we can add the Jenkins user to the repository members list - OR - add the Jenkins user to a Group that has access to the repositories.</p><ul><li>Within the repository menu, select the Settings → Members link.</li><li>Select the newly created Jenkins user, and give that user 'Developer' permissions, with no expiration date.</li><li>Click 'Add to project'</li></ul><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="490" width="641" src="attachments/58851367/61964301.png?width=641" data-image-src="attachments/58851367/61964301.png" data-unresolved-comment-count="0" data-linked-resource-id="61964301" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="gl3.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="167cd183-b8b3-4bc5-b906-d0835e8f8b27" data-media-type="file"></span></p><p>Finally, we need to add the Jenkins users' SSH keys to the profile</p><ul><li>Log in to GitLab as the new Jenkins user. Click on the user avatar and select Settings.</li><li>Select the 'SSH Keys' tab.</li><li>Add a new SSH key, and upload the public ssh key for the jenkins user on the Jenkins server.</li></ul><p style="margin-left: 30.0px;"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="227" width="741" src="attachments/58851367/62193672.png?width=741" data-image-src="attachments/58851367/62193672.png" data-unresolved-comment-count="0" data-linked-resource-id="62193672" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="gl4.png" data-base-url="https://redhat-anzservices.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="58851367" data-linked-resource-container-version="12" data-media-id="93330c31-38b2-4556-8b4b-7929b67f67d4" data-media-type="file"></span></p><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>If GitLab is installed with a self-signed SSL certificate, it may be necessary to disable SSL verification witihin git for the Jenkins user.</p><pre>  # su - jenkins -s /bin/bash</pre><pre>  $ git config --global http.sslverify false</pre></div></div><p><br/></p><h2 id="GitServer-Bitbucket">Bitbucket</h2><h3 id="GitServer-Setthedefaultbranch.2">Set the default branch</h3><p><br/></p><h3 id="GitServer-Protectthemasterbranch.2">Protect the master branch</h3><p>TBA (Not yet implemented &amp; tested)</p><h3 id="GitServer-Configurewebhooks.2">Configure webhooks</h3><p><br/></p><h3 id="GitServer-AllowJenkinsaccess.2">Allow Jenkins access</h3><p><br/></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/58818641.png">soe1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/58851407.png">soe2.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/58294364.png">soe3.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/61931524.jpg">gl1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/61833223.png">gl2.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/61964301.png">gl3.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/62193672.png">gl4.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/63307814.png">gl04.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/64454693.png">wh1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/58851367/64847913.png">wh2.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Aug 12, 2017 18:01</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
